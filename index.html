<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function() {
    const memoryStorage = {};
    const safeStorage = {
        getItem: function(key) { try { return localStorage.getItem(key); } catch(e) { return memoryStorage[key] || null; } },
        setItem: function(key, value) { try { localStorage.setItem(key, value); } catch(e) { memoryStorage[key] = String(value); } },
        removeItem: function(key) { try { localStorage.removeItem(key); } catch(e) { delete memoryStorage[key]; } }
    };
    try { localStorage.setItem('test', 'test'); localStorage.removeItem('test'); }
    catch(e) { Object.defineProperty(window, 'localStorage', { value: safeStorage, writable: false, configurable: false }); }
})();
</script>
<base href="https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Games</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
:root {
    --c0: #050508;
    --c1: #0d0d14;
    --c2: #141420;
    --c3: #1c1c2e;
    --c4: #252540;
    --accent: #00f5a0;
    --accent2: #00d4ff;
    --accent3: #ff6b35;
    --text: #e8e8f0;
    --muted: #7070a0;
    --dim: #404060;
    --border: rgba(255,255,255,0.06);
    --glow: 0 0 30px rgba(0,245,160,0.15);
    --font-display: 'Bebas Neue', sans-serif;
    --font-mono: 'Space Mono', monospace;
    --font-body: 'DM Sans', sans-serif;
    --r: 8px;
    --r2: 14px;
    --transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
}
*{box-sizing:border-box;margin:0;padding:0;scrollbar-width:thin;scrollbar-color:var(--c4) var(--c0);}
::-webkit-scrollbar{width:8px;background:var(--c0);}
::-webkit-scrollbar-thumb{background:var(--c4);border-radius:4px;}
body{background:var(--c0);color:var(--text);font-family:var(--font-body);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}

/* Noise overlay */
body::before{
    content:'';position:fixed;inset:0;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events:none;z-index:9999;opacity:0.4;
}

/* Grid background */
body::after{
    content:'';position:fixed;inset:0;
    background-image:linear-gradient(rgba(0,245,160,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,160,0.03) 1px,transparent 1px);
    background-size:40px 40px;
    pointer-events:none;z-index:0;
}

/* ─── HEADER ─── */
header{
    position:sticky;top:0;z-index:1000;
    background:rgba(5,5,8,0.92);
    backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
}
.header-inner{
    max-width:1400px;margin:0 auto;
    padding:0 1.5rem;
    display:flex;align-items:center;gap:2rem;height:64px;
}
.logo{
    font-family:var(--font-display);
    font-size:2rem;letter-spacing:0.08em;
    color:var(--accent);
    cursor:pointer;
    text-shadow:0 0 20px rgba(0,245,160,0.4);
    white-space:nowrap;
    flex-shrink:0;
}
.logo span{color:var(--muted);}
.search-wrap{flex:1;max-width:460px;position:relative;}
#searchBar{
    width:100%;padding:0.6rem 1rem 0.6rem 2.75rem;
    background:var(--c2);
    border:1px solid var(--border);
    border-radius:var(--r);
    color:var(--text);font-family:var(--font-mono);font-size:0.8rem;
    outline:none;transition:var(--transition);
}
#searchBar::placeholder{color:var(--dim);}
#searchBar:focus{border-color:var(--accent);background:var(--c3);box-shadow:0 0 0 3px rgba(0,245,160,0.08);}
.search-ico{position:absolute;left:0.9rem;top:50%;transform:translateY(-50%);color:var(--dim);pointer-events:none;}
.header-btns{display:flex;gap:0.5rem;margin-left:auto;}
.btn-ico{
    width:38px;height:38px;display:flex;align-items:center;justify-content:center;
    border-radius:var(--r);background:var(--c2);border:1px solid var(--border);
    color:var(--muted);cursor:pointer;transition:var(--transition);
}
.btn-ico:hover{background:var(--c3);border-color:var(--accent);color:var(--accent);}

/* ─── NAV ─── */
.nav-bar{background:var(--c1);border-bottom:1px solid var(--border);}
.nav-inner{max-width:1400px;margin:0 auto;padding:0 1.5rem;display:flex;gap:0;overflow-x:auto;scrollbar-width:none;}
.nav-inner::-webkit-scrollbar{display:none;}
.nav-link{
    padding:0.75rem 1.25rem;color:var(--muted);
    font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.12em;text-transform:uppercase;
    cursor:pointer;white-space:nowrap;transition:var(--transition);
    border-bottom:2px solid transparent;
    position:relative;
}
.nav-link:hover{color:var(--text);}
.nav-link.active{color:var(--accent);border-bottom-color:var(--accent);}

/* ─── MAIN ─── */
main{flex:1;position:relative;z-index:1;}
.page{max-width:1400px;margin:0 auto;padding:2rem 1.5rem;}

/* ─── HERO SLIDER ─── */
.hero-wrap{margin-bottom:3rem;position:relative;}
.swiper.hero-swiper{border-radius:var(--r2);overflow:hidden;}
.hero-slide{
    height:380px;position:relative;overflow:hidden;cursor:pointer;
    background:var(--c1);
}
.hero-bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(24px) brightness(0.25);transform:scale(1.1);}
.hero-content{position:relative;z-index:2;height:100%;display:flex;align-items:center;gap:3rem;padding:2.5rem;}
.hero-img-wrap{
    width:280px;flex-shrink:0;height:100%;
    display:flex;align-items:center;justify-content:center;
}
.hero-img{width:100%;height:220px;object-fit:contain;border-radius:var(--r);filter:drop-shadow(0 10px 40px rgba(0,0,0,0.6));}
.hero-info{flex:1;}
.hero-cat{
    display:inline-block;padding:0.2rem 0.75rem;
    background:rgba(0,245,160,0.12);border:1px solid rgba(0,245,160,0.3);
    border-radius:4px;color:var(--accent);font-family:var(--font-mono);
    font-size:0.68rem;letter-spacing:0.12em;text-transform:uppercase;
    margin-bottom:1rem;
}
.hero-title{font-family:var(--font-display);font-size:3.5rem;letter-spacing:0.04em;line-height:1;color:#fff;margin-bottom:1.25rem;}
.hero-play{
    display:inline-flex;align-items:center;gap:0.6rem;
    padding:0.875rem 2rem;background:var(--accent);color:var(--c0);
    font-family:var(--font-mono);font-size:0.78rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;
    border-radius:var(--r);border:none;cursor:pointer;transition:var(--transition);
}
.hero-play:hover{background:#00d488;transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,245,160,0.3);}
.hero-play svg{transition:transform 0.2s;}
.hero-play:hover svg{transform:translateX(3px);}

/* ─── SECTION HEADERS ─── */
.sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;margin-top:2.5rem;}
.sec-title{
    font-family:var(--font-display);font-size:1.6rem;letter-spacing:0.06em;color:var(--text);
    display:flex;align-items:center;gap:0.75rem;
}
.sec-title::before{content:'';display:block;width:3px;height:1.4rem;background:var(--accent);border-radius:2px;}
.sec-subtitle{font-family:var(--font-mono);font-size:0.68rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-top:0.2rem;}

/* ─── GAME CARDS ─── */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:1rem;}
.card{
    background:var(--c2);border:1px solid var(--border);border-radius:var(--r2);
    overflow:hidden;cursor:pointer;transition:var(--transition);
    display:flex;flex-direction:column;position:relative;
    opacity:0;animation:cardIn 0.35s cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes cardIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.card:hover{transform:translateY(-6px);border-color:rgba(0,245,160,0.3);box-shadow:0 12px 40px rgba(0,245,160,0.1);}
.card-thumb{width:100%;aspect-ratio:1;object-fit:cover;background:var(--c3);}
.card-fav{
    position:absolute;top:8px;right:8px;
    background:rgba(5,5,8,0.7);border:1px solid var(--border);
    border-radius:6px;width:28px;height:28px;
    display:flex;align-items:center;justify-content:center;
    font-size:0.85rem;color:var(--dim);cursor:pointer;
    transition:var(--transition);backdrop-filter:blur(8px);
}
.card-fav:hover{color:var(--text);}
.card-fav.starred{color:#fbbf24;border-color:rgba(251,191,36,0.3);}
.card-body{padding:0.875rem;flex:1;display:flex;flex-direction:column;}
.card-title{font-weight:600;font-size:0.9rem;color:var(--text);margin-bottom:0.3rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.card-tags{font-size:0.72rem;color:var(--muted);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.05em;}
.card-plays{
    margin-top:0.6rem;display:flex;align-items:center;gap:0.4rem;
    font-size:0.7rem;color:var(--dim);font-family:var(--font-mono);
}
.plays-dot{width:4px;height:4px;border-radius:50%;background:var(--accent);}

/* ─── HORIZONTAL SCROLL ─── */
.h-scroll-wrap{margin-bottom:2.5rem;overflow:hidden;position:relative;}
.h-scroll-wrap::before,.h-scroll-wrap::after{
    content:'';position:absolute;top:0;bottom:0;width:80px;z-index:10;pointer-events:none;
}
.h-scroll-wrap::before{left:0;background:linear-gradient(to right,var(--c0),transparent);}
.h-scroll-wrap::after{right:0;background:linear-gradient(to left,var(--c0),transparent);}
.swiper.h-swiper{padding:1rem 0;}
.h-swiper .swiper-slide{width:180px;height:280px;}
.h-swiper .card{height:100%;}

/* swiper nav */
.swiper-button-prev,.swiper-button-next{
    width:36px!important;height:36px!important;
    background:var(--c3);border:1px solid var(--border);border-radius:50%;
    color:var(--accent)!important;transition:var(--transition);
    top:50%!important;margin-top:-18px!important;
}
.swiper-button-prev:hover,.swiper-button-next:hover{background:var(--c4);border-color:var(--accent);}
.swiper-button-prev::after,.swiper-button-next::after{font-size:12px!important;font-weight:900!important;}

/* ─── SORT SELECT ─── */
#sortOptions{
    padding:0.5rem 1rem;background:var(--c2);border:1px solid var(--border);
    border-radius:var(--r);color:var(--text);font-family:var(--font-mono);font-size:0.75rem;
    cursor:pointer;outline:none;transition:var(--transition);
}
#sortOptions:focus,#sortOptions:hover{border-color:var(--accent);}

/* ─── ZONE VIEWER ─── */
#zoneViewer{
    position:fixed;inset:0;z-index:5000;
    display:none;flex-direction:column;
    animation:slideUp 0.3s cubic-bezier(0.4,0,0.2,1);
    background:var(--c0);
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.zone-hdr{
    background:var(--c1);border-bottom:1px solid var(--border);
    padding:0 1.5rem;height:56px;
    display:flex;align-items:center;gap:1.5rem;
    flex-shrink:0;
}
#zoneName{
    font-family:var(--font-display);font-size:1.3rem;letter-spacing:0.05em;color:var(--text);
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;
}
.zone-btns{display:flex;gap:0.5rem;flex-shrink:0;}
.zone-btn{
    padding:0.4rem 1rem;background:var(--c2);border:1px solid var(--border);
    color:var(--muted);border-radius:var(--r);cursor:pointer;
    font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.05em;
    transition:var(--transition);white-space:nowrap;
}
.zone-btn:hover{border-color:var(--accent);color:var(--accent);}
.zone-btn.primary{background:var(--accent);color:var(--c0);border-color:var(--accent);}
.zone-btn.primary:hover{background:#00d488;}
#zoneFrame{flex:1;border:none;width:100%;background:#000;}
#zoneId{display:none;}

/* ─── MODAL ─── */
.modal-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);
    z-index:6000;display:none;align-items:center;justify-content:center;
    opacity:0;transition:opacity 0.2s;
}
.modal-overlay.open{opacity:1;}
.modal{
    background:var(--c2);border:1px solid var(--border);border-radius:var(--r2);
    width:100%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,0.6);
    transform:scale(0.96);transition:transform 0.2s;
}
.modal-overlay.open .modal{transform:scale(1);}
.modal-hdr{
    padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;
}
.modal-title{font-family:var(--font-display);font-size:1.3rem;letter-spacing:0.06em;color:var(--text);}
.modal-close{background:none;border:none;color:var(--muted);font-size:1.4rem;cursor:pointer;line-height:1;transition:var(--transition);}
.modal-close:hover{color:var(--text);}
.modal-body{padding:1.5rem;max-height:70vh;overflow-y:auto;color:var(--muted);line-height:1.7;font-size:0.9rem;}

/* Settings */
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:0.875rem 0;border-bottom:1px solid var(--border);}
.setting-label{font-size:0.875rem;color:var(--text);font-weight:500;}
.toggle{position:relative;width:44px;height:24px;background:var(--c4);border-radius:12px;cursor:pointer;transition:var(--transition);}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:var(--transition);}
.toggle.on{background:var(--accent);}
.toggle.on::after{transform:translateX(20px);}
.set-btn{
    padding:0.5rem 1.25rem;background:var(--c3);border:1px solid var(--border);
    color:var(--text);border-radius:var(--r);cursor:pointer;font-family:var(--font-mono);font-size:0.75rem;
    transition:var(--transition);
}
.set-btn:hover{border-color:var(--accent);color:var(--accent);}
.set-select{
    padding:0.4rem 0.75rem;background:var(--c3);border:1px solid var(--border);
    border-radius:var(--r);color:var(--text);font-family:var(--font-mono);font-size:0.75rem;
    cursor:pointer;outline:none;
}
.set-select:focus{border-color:var(--accent);}
.sec-divider{
    margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border);
}
.sec-divider h4{color:var(--text);font-family:var(--font-mono);font-size:0.75rem;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:1rem;}

/* ─── FOOTER ─── */
footer{background:var(--c1);border-top:1px solid var(--border);padding:3rem 1.5rem;position:relative;z-index:1;}
.footer-inner{max-width:1400px;margin:0 auto;display:flex;gap:4rem;flex-wrap:wrap;}
.footer-col h3{font-family:var(--font-mono);font-size:0.72rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:1.25rem;}
.footer-links{display:flex;flex-direction:column;gap:0.6rem;}
.footer-link{color:var(--muted);font-size:0.85rem;cursor:pointer;transition:var(--transition);text-decoration:none;display:inline-block;}
.footer-link:hover{color:var(--text);transform:translateX(4px);}
.footer-brand{font-family:var(--font-display);font-size:1.8rem;letter-spacing:0.06em;color:var(--accent);text-shadow:0 0 20px rgba(0,245,160,0.3);margin-bottom:0.5rem;}
.footer-tagline{font-size:0.8rem;color:var(--dim);font-family:var(--font-mono);}

/* ─── SEARCH + CATEGORY VIEW ─── */
.hidden{display:none!important;}

/* Stats strip */
.stats-badge{
    display:inline-flex;align-items:center;gap:0.4rem;
    padding:0.25rem 0.6rem;background:rgba(0,245,160,0.07);
    border:1px solid rgba(0,245,160,0.15);border-radius:4px;
    font-family:var(--font-mono);font-size:0.68rem;color:var(--accent);
}

/* Classic grid */
.classic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.75rem;}
.classic-card{background:var(--c2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:var(--transition);}
.classic-card:hover{transform:scale(1.04);border-color:var(--accent);}
.classic-thumb{width:100%;aspect-ratio:1;object-fit:cover;}
.classic-title{padding:0.5rem;font-size:0.78rem;text-align:center;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* Collapse */
.collapse-arrow{transition:transform 0.25s;}

@media(max-width:768px){
    .header-inner{height:56px;gap:1rem;}
    .logo{font-size:1.5rem;}
    .hero-slide{height:260px;}
    .hero-img-wrap{display:none;}
    .hero-title{font-size:2.2rem;}
    .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));}
    .h-swiper .swiper-slide{width:150px;height:250px;}
    .zone-hdr{padding:0 1rem;height:auto;padding-top:0.75rem;padding-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;}
    .zone-btns{flex-wrap:wrap;}
    .zone-btn{padding:0.35rem 0.75rem;font-size:0.68rem;}
    .footer-inner{gap:2rem;}
}
@media(max-width:480px){
    .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));}
    .hero-title{font-size:1.8rem;}
}
.hidden{display:none!important;}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo" onclick="location.reload()">◈ <span style="font-family:var(--font-mono);font-size:1rem;letter-spacing:0.15em;color:var(--muted);">GAMES</span></div>
    <div class="search-wrap">
      <svg class="search-ico" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" id="searchBar" placeholder="Search games..." oninput="handleSearch(this.value)">
    </div>
    <div class="header-btns">
      <button class="btn-ico" onclick="listZones()" title="Refresh">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
      </button>
      <button class="btn-ico" onclick="openSettings()" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
    </div>
  </div>
  <div class="nav-bar">
    <div class="nav-inner" id="navContent">
      <div class="nav-link active" onclick="switchView('all',this)">All Games</div>
    </div>
  </div>
</header>

<main>
  <div id="modernView" class="page">
    <div class="hero-wrap">
      <div class="swiper hero-swiper">
        <div class="swiper-wrapper" id="heroWrapper"></div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
      </div>
    </div>

    <div class="sec-header">
      <div>
        <div class="sec-title">Trending Now</div>
      </div>
    </div>
    <div class="h-scroll-wrap">
      <div class="swiper h-swiper" id="trendingSwiper">
        <div class="swiper-wrapper" id="trendingWrapper"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
      </div>
    </div>

    <div id="tagSections"></div>

    <div class="sec-header">
      <div class="sec-title" onclick="toggleSection('featuredGrid',this)" style="cursor:pointer;">
        Featured
        <svg class="collapse-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
      </div>
    </div>
    <div class="grid" id="featuredGrid"></div>

    <div class="sec-header" style="margin-top:2.5rem;">
      <div class="sec-title" onclick="toggleSection('allGamesGrid',this)" style="cursor:pointer;">
        All Games
        <svg class="collapse-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
      </div>
      <select id="sortOptions" onchange="sortZones()">
        <option value="id">Latest</option>
        <option value="name">A–Z</option>
        <option value="popular">Most Played</option>
      </select>
    </div>
    <div class="grid" id="allGamesGrid"></div>
  </div>

  <div id="classicView" class="page hidden">
    <div class="sec-header"><div class="sec-title">All Games</div></div>
    <div class="classic-grid" id="classicGrid"></div>
  </div>

  <div id="searchView" class="page hidden">
    <div class="sec-header"><div class="sec-title" id="searchTitle">Results</div></div>
    <div class="grid" id="searchResults"></div>
  </div>
</main>

<footer>
  <div class="footer-inner">
    <div class="footer-col">
      <div class="footer-tagline">// free unblocked games</div>
    </div>
    <div class="footer-col">
      <h3>Data</h3>
      <div class="footer-links">
        <a class="footer-link" onclick="saveData()">Export Save Data</a>
        <a class="footer-link" onclick="document.getElementById('importFile').click()">Import Save Data</a>
        <input type="file" id="importFile" style="display:none" onchange="loadData(event)">
      </div>
    </div>
  </div>
</footer>

<!-- Zone Viewer -->
<div id="zoneViewer">
  <div class="zone-hdr">
    <div id="zoneName">Game</div>
    <span id="zoneId" style="display:none"></span>
    <div class="zone-btns">
      <button class="zone-btn" onclick="showZoneInfo()">Info</button>
      <button class="zone-btn" onclick="fullscreenZone()">Fullscreen</button>
      <button class="zone-btn primary" onclick="closeZone()">✕ Close</button>
    </div>
  </div>
  <iframe id="zoneFrame"></iframe>
</div>

<!-- Modal -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-hdr">
      <div class="modal-title" id="modalTitle">Modal</div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalContent"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
const CONFIG = {
    zones: "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json",
    tagsZones: "https://cdn.jsdelivr.net/gh/sealiee11/gnmathstuff@main/zones.json",
    covers: "https://cdn.jsdelivr.net/gh/gn-math/covers@main",
    html: "https://cdn.jsdelivr.net/gh/gn-math/html@main",
    stats: "https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period="
};

let state = { games: [], hits: {}, theme: 'modern', categories: [], tagGames: [] };

async function init() {
    try {
        const r = await fetch(CONFIG.zones + "?t=" + Date.now());
        state.games = (await r.json()).filter(g => !g.name.startsWith('[!]') && !g.name.toLowerCase().includes('suggest') && !g.name.toLowerCase().includes('comment') && !g.name.toLowerCase().includes('.gg/'));
        try {
            const tr = await fetch(CONFIG.tagsZones + "?t=" + Date.now());
            state.tagGames = (await tr.json()).filter(g => !g.name.startsWith('[!]') && !g.name.toLowerCase().includes('suggest') && !g.name.toLowerCase().includes('comment') && !g.name.toLowerCase().includes('.gg/'));
        } catch(e) { state.tagGames = state.games; }
        if (state.games.length) state.games[0].featured = true;
        extractCategories();
        renderApp();
        const id = new URLSearchParams(window.location.search).get('id');
        if (id) { const z = state.games.find(z => z.id+'' == id+''); if (z) openGame(z.id); }
        fetchAllStats('day'); fetchAllStats('week'); fetchAllStats('month');
        fetchAllStats('quarter'); fetchAllStats('year'); getAllStats();
    } catch(e) { console.error("Init failed", e); }
}

async function fetchAllStats(period) {
    if (!state.hits[period]) state.hits[period] = {};
    let page = 1, hasMore = true;
    while (hasMore) {
        try {
            const res = await fetch(`${CONFIG.stats}${period}&page=${page}`);
            const data = await res.json();
            if (!data || !data.length) { hasMore = false; }
            else {
                data.forEach(f => {
                    const m = f.name.match(/\/(\d+)\.html/);
                    if (m) { if (!state.hits[period][m[1]]) state.hits[period][m[1]] = 0; state.hits[period][m[1]] += f.hits.total; }
                });
                page++; if (page === 2) updatePlayCounts();
            }
        } catch(e) { hasMore = false; }
    }
    updatePlayCounts();
    if (period === 'week') { updateTrendingWeek(); updateTagSections(); }
}

function updateTrendingWeek() {
    const top = [...state.games].sort((a,b) => getScore(b,'week') - getScore(a,'week')).slice(0,15);
    const favs = JSON.parse(localStorage.getItem('favorites')||'[]');
    const el = document.getElementById('trendingWrapper');
    if (el) el.innerHTML = top.map(g => makeSlide(g, favs, 'week')).join('');
}

function makeSlide(g, favs, period='week') {
    const favsNum = favs.map(Number);
    return `<div class="swiper-slide"><div class="card" onclick="event.stopPropagation();openGame(${g.id})">
        <div class="card-fav ${favsNum.includes(Number(g.id))?'starred':''}" onclick="event.stopPropagation();toggleFavorite(${g.id})">★</div>
        <img src="${resolveUrl(g.cover)}" class="card-thumb" loading="lazy">
        <div class="card-body">
            <div class="card-title">${g.name}</div>
            <div class="card-tags">${(g.special||[]).slice(0,2).map(toTitle).join(' · ')}</div>
            <div class="card-plays"><span class="plays-dot"></span>${fmt(getScore(g,period))} plays</div>
        </div>
    </div></div>`;
}

function updateTagSections() {
    const count = state.tagCount || 0;
    for (let i=0; i<count; i++) {
        const el = document.getElementById(`tagWrapper${i}`);
        if (!el) continue;
        el.querySelectorAll('.card-plays').forEach(row => {
            const card = row.closest('[onclick]');
            if (!card) return;
            const m = card.getAttribute('onclick').match(/openGame\((\d+)\)/);
            if (!m) return;
            const g = state.games.find(x => x.id === parseInt(m[1]));
            if (g) row.innerHTML = `<span class="plays-dot"></span>${fmt(getScore(g,'week'))} plays`;
        });
    }
}

function updatePlayCounts() {
    document.querySelectorAll('.card-plays').forEach(async el => {
        const card = el.closest('[onclick]');
        if (!card) return;
        const m = card.getAttribute('onclick').match(/openGame\((\d+)\)/);
        if (!m) return;
        const plays = await getStats(m[1]);
        el.innerHTML = `<span class="plays-dot"></span>${fmt(plays)} plays`;
    });
}

function extractCategories() {
    const s = new Set();
    state.games.forEach(g => { if (g.special) g.special.forEach(x => s.add(x)); });
    state.categories = Array.from(s).sort();
}

function getScore(g, period) { return state.hits[period]?.[g.id] || 0; }
function fmt(n) {
    if (n >= 1e6) return (n/1e6).toFixed(1)+'m';
    if (n >= 1000) return (n/1000).toFixed(1)+'k';
    return n.toString();
}
function resolveUrl(u) { return u.replace("{COVER_URL}", CONFIG.covers).replace("{HTML_URL}", CONFIG.html); }
function toTitle(s) { return s.replace(/\w\S*/g, t => t[0].toUpperCase()+t.slice(1).toLowerCase()); }

function renderTagSections() {
    const allTags = new Set();
    state.tagGames.forEach(g => { if (g.tags) g.tags.forEach(t => allTags.add(t)); });
    const tags = Array.from(allTags).sort(() => Math.random()-0.5).slice(0, 3);
    if (!tags.length) return 0;
    const container = document.getElementById('tagSections');
    container.innerHTML = tags.map((tag,i) => `
        <div class="sec-header"><div class="sec-title">${tag}</div></div>
        <div class="h-scroll-wrap">
          <div class="swiper h-swiper" id="tagSwiper${i}">
            <div class="swiper-wrapper" id="tagWrapper${i}"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
          </div>
        </div>
    `).join('');
    tags.forEach((tag, i) => {
        const games = state.tagGames.filter(g => g.tags?.includes(tag)).slice(0,15);
        const favs = JSON.parse(localStorage.getItem('favorites')||'[]');
        const el = document.getElementById(`tagWrapper${i}`);
        if (el && games.length) el.innerHTML = games.map(g => makeSlide(g, favs)).join('');
    });
    return tags.length;
}

function renderApp() {
    if (localStorage.getItem('theme') === 'classic') toggleTheme(true);
    renderNav();
    const popular = state.games.filter(g => (g.featured || g.special?.includes('popular')) && !g.special?.includes('tools'));
    const rands = state.games.filter(g => !g.special?.includes('tools')).sort(() => Math.random()-0.5).slice(0,2);
    const featured = [...new Set([popular[0], ...rands, popular[1]])].filter(Boolean).slice(0,5);
    renderHero(featured);
    renderHSlider('trendingWrapper', state.games.slice(0,15));
    state.tagCount = renderTagSections() || 0;
    renderGrid('featuredGrid', state.games.filter(g => g.featured));
    renderGrid('allGamesGrid', [...state.games].sort((a,b) => a.id-b.id));
    renderClassicGrid();
    initSwipers();
}

function renderNav() {
    const nav = document.getElementById('navContent');
    nav.innerHTML = '';
    const allLink = document.createElement('div');
    allLink.className = 'nav-link active';
    allLink.textContent = 'All Games';
    allLink.onclick = () => switchView('all', allLink);
    nav.appendChild(allLink);
    const favLink = document.createElement('div');
    favLink.className = 'nav-link';
    favLink.textContent = '★ Favorites';
    favLink.onclick = () => filterFavorites(favLink);
    nav.appendChild(favLink);
}

function filterFavorites(el) {
    setActiveNav(el);
    showSearchView('★ Favorites');
    document.getElementById('searchBar').value = '';
    const favs = JSON.parse(localStorage.getItem('favorites') || '[]').map(Number);
    const hits = state.games.filter(g => favs.includes(Number(g.id)));
    if (hits.length === 0) {
        document.getElementById('searchResults').innerHTML = '<p style="color:var(--muted);padding:3rem 1rem;font-family:var(--font-mono);font-size:0.8rem;text-align:center;">No favorites yet — click ★ on any game to save it here.</p>';
    } else {
        renderSearchResults(hits);
    }
}

function filterByCategory(cat, el) {
    setActiveNav(el);
    showSearchView(toTitle(cat));
    document.getElementById('searchBar').value = '';
    const results = state.games.filter(g => g.special?.includes(cat));
    if (results.length === 0) {
        document.getElementById('searchResults').innerHTML = '<p style="color:var(--muted);padding:2rem;font-family:var(--font-mono);font-size:0.8rem;">No games found in this category.</p>';
    } else {
        renderSearchResults(results);
    }
}

function setActiveNav(el) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
}

function showSearchView(title) {
    document.getElementById('modernView').classList.add('hidden');
    document.getElementById('classicView').classList.add('hidden');
    document.getElementById('searchView').classList.remove('hidden');
    if (title) document.getElementById('searchTitle').textContent = title;
}

function renderSearchResults(games) {
    const favs = JSON.parse(localStorage.getItem('favorites')||'[]');
    document.getElementById('searchResults').innerHTML = games.map((g,i) => makeCard(g, favs, i)).join('');
}

function toggleFavorite(id) {
    id = Number(id);
    const favs = JSON.parse(localStorage.getItem('favorites') || '[]').map(Number);
    const i = favs.indexOf(id);
    if (i > -1) {
        favs.splice(i, 1);
    } else {
        favs.push(id);
    }
    localStorage.setItem('favorites', JSON.stringify(favs));
    // Update all star icons for this game across the page
    document.querySelectorAll(`.card-fav[onclick*="toggleFavorite(${id})"]`).forEach(star => {
        star.classList.toggle('starred', favs.includes(id));
    });
    // If currently viewing favorites, refresh the view
    const searchTitle = document.getElementById('searchTitle');
    if (searchTitle && searchTitle.textContent.includes('Favorites') && !document.getElementById('searchView').classList.contains('hidden')) {
        const hits = state.games.filter(g => favs.includes(Number(g.id)));
        if (hits.length === 0) {
            document.getElementById('searchResults').innerHTML = '<p style="color:var(--muted);padding:3rem 1rem;font-family:var(--font-mono);font-size:0.8rem;text-align:center;">No favorites yet — click ★ on any game to save it here.</p>';
        } else {
            renderSearchResults(hits);
        }
    }
}

function makeCard(g, favs, index=0) {
    const favsNum = favs.map(Number);
    const delay = Math.min(index,20)*0.03;
    return `<div class="card" onclick="openGame(${g.id})" style="animation-delay:${delay}s" data-index="${index}">
        <div class="card-fav ${favsNum.includes(Number(g.id))?'starred':''}" onclick="event.stopPropagation();toggleFavorite(${g.id})">★</div>
        <img src="${resolveUrl(g.cover)}" class="card-thumb" loading="lazy">
        <div class="card-body">
            <div class="card-title">${g.name}</div>
            <div class="card-tags">${(g.special||[]).slice(0,2).map(toTitle).join(' · ')}</div>
            <div class="card-plays"><span class="plays-dot"></span>...</div>
        </div>
    </div>`;
}

function renderHero(games) {
    document.getElementById('heroWrapper').innerHTML = games.map(g => `
        <div class="swiper-slide">
            <div class="hero-slide" onclick="openGame(${g.id})">
                <div class="hero-bg" style="background-image:url('${resolveUrl(g.cover)}')"></div>
                <div class="hero-content">
                    <div class="hero-img-wrap">
                        <img src="${resolveUrl(g.cover)}" class="hero-img" loading="lazy">
                    </div>
                    <div class="hero-info">
                        <div class="hero-cat">${(g.special||['game'])[0]}</div>
                        <h1 class="hero-title">${g.name}</h1>
                        <button class="hero-play" onclick="event.stopPropagation();openGame(${g.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            Play Now
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderHSlider(id, games) {
    const favs = JSON.parse(localStorage.getItem('favorites')||'[]');
    document.getElementById(id).innerHTML = games.map(g => makeSlide(g, favs)).join('');
    updatePlayCounts();
}

function renderGrid(id, games) {
    const favs = JSON.parse(localStorage.getItem('favorites')||'[]');
    document.getElementById(id).innerHTML = games.map((g,i) => makeCard(g,favs,i)).join('');
    updatePlayCounts();
}

function renderClassicGrid() {
    document.getElementById('classicGrid').innerHTML = state.games.map(g => `
        <div class="classic-card" onclick="openGame(${g.id})">
            <img src="${resolveUrl(g.cover)}" class="classic-thumb" loading="lazy">
            <div class="classic-title">${g.name}</div>
        </div>
    `).join('');
}

function sortZones() {
    const by = document.getElementById('sortOptions').value;
    let s = [...state.games];
    if (by === 'name') s.sort((a,b) => a.name.localeCompare(b.name));
    else if (by === 'id') s.sort((a,b) => b.id-a.id);
    else if (by === 'popular') s.sort((a,b) => getScore(b,'year')-getScore(a,'year'));
    renderGrid('allGamesGrid', s);
}

let heroSwiper, trendingSwiper;
function initSwipers() {
    if (heroSwiper) heroSwiper.destroy(true,true);
    heroSwiper = new Swiper('.hero-swiper', {
        loop:true, centeredSlides:false, slidesPerView:1,
        autoplay:{delay:5000,disableOnInteraction:false},
        pagination:{el:'.swiper-pagination',clickable:true},
        navigation:{nextEl:'.hero-swiper .swiper-button-next',prevEl:'.hero-swiper .swiper-button-prev'},
        speed:600
    });
    if (trendingSwiper) trendingSwiper.destroy(true,true);
    trendingSwiper = new Swiper('#trendingSwiper', {
        slidesPerView:2, spaceBetween:16, speed:400,
        navigation:{nextEl:'#trendingSwiper .swiper-button-next',prevEl:'#trendingSwiper .swiper-button-prev'},
        breakpoints:{480:{slidesPerView:3},640:{slidesPerView:3},768:{slidesPerView:4},1024:{slidesPerView:5},1280:{slidesPerView:6}}
    });
    for (let i=0; i<(state.tagCount||0); i++) {
        const el = document.getElementById(`tagSwiper${i}`);
        if (el) new Swiper(`#tagSwiper${i}`, {
            slidesPerView:2, spaceBetween:16, speed:400,
            navigation:{nextEl:`#tagSwiper${i} .swiper-button-next`,prevEl:`#tagSwiper${i} .swiper-button-prev`},
            breakpoints:{480:{slidesPerView:3},640:{slidesPerView:3},768:{slidesPerView:4},1024:{slidesPerView:5},1280:{slidesPerView:6}}
        });
    }
}

function handleSearch(q) {
    if (!q) {
        document.getElementById('searchView').classList.add('hidden');
        if (state.theme === 'classic') document.getElementById('classicView').classList.remove('hidden');
        else document.getElementById('modernView').classList.remove('hidden');
        return;
    }
    document.getElementById('modernView').classList.add('hidden');
    document.getElementById('classicView').classList.add('hidden');
    showSearchView(`"${q}"`);
    renderSearchResults(state.games.filter(g => g.name.toLowerCase().includes(q.toLowerCase())));
}

function switchView(v, el) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('searchBar').value = '';
    // Hide search view, show main view
    document.getElementById('searchView').classList.add('hidden');
    if (state.theme === 'classic') {
        document.getElementById('classicView').classList.remove('hidden');
        document.getElementById('modernView').classList.add('hidden');
    } else {
        document.getElementById('modernView').classList.remove('hidden');
        document.getElementById('classicView').classList.add('hidden');
    }
}

async function openGame(id) {
    const g = state.games.find(x => x.id === id);
    if (!g) return;
    const stats = JSON.parse(localStorage.getItem('userStats')||'{"opens":{},"timeStart":null}');
    stats.opens[id] = (stats.opens[id]||0)+1;
    stats.timeStart = Date.now();
    localStorage.setItem('userStats', JSON.stringify(stats));
    document.getElementById('zoneName').textContent = g.name;
    document.getElementById('zoneId').textContent = id;
    const v = document.getElementById('zoneViewer');
    v.style.display = 'flex';
    document.querySelector('header').style.display = 'none';
    document.querySelector('main').style.display = 'none';
    document.querySelector('footer').style.display = 'none';
    const url = new URL(window.location);
    url.searchParams.set('id', id);
    history.pushState(null,'',url.toString());
    if (g.url.startsWith('http') && !g.url.includes('{')) { window.open(g.url,'_blank'); closeZone(); return; }
    try {
        const u = resolveUrl(g.url);
        const r = await fetch(u + "?t=" + Date.now());
        const h = await r.text();
        const baseUrl = u.substring(0, u.lastIndexOf('/') + 1);
        // Inject base tag so relative asset paths resolve correctly, then load via blob URL
        // This avoids document.write cross-origin issues that break Unity and other engines
        const htmlWithBase = h.includes('<base') ? h : h.replace('<head>', `<head><base href="${baseUrl}">`);
        const blob = new Blob([htmlWithBase], { type: 'text/html' });
        const blobUrl = URL.createObjectURL(blob);
        const f = document.getElementById('zoneFrame');
        // Clean up previous blob URL if any
        if (f._blobUrl) URL.revokeObjectURL(f._blobUrl);
        f._blobUrl = blobUrl;
        f.src = blobUrl;
    } catch(e) { alert("Failed to load game."); closeZone(); }
}

function closeZone() {
    const stats = JSON.parse(localStorage.getItem('userStats')||'{"opens":{},"timeStart":null,"totalTime":0}');
    if (stats.timeStart) { stats.totalTime = (stats.totalTime||0)+(Date.now()-stats.timeStart); stats.timeStart = null; localStorage.setItem('userStats',JSON.stringify(stats)); }
    const f = document.getElementById('zoneFrame');
    if (f._blobUrl) { URL.revokeObjectURL(f._blobUrl); f._blobUrl = null; }
    f.src = '';
    document.getElementById('zoneViewer').style.display = 'none';
    document.querySelector('header').style.display = '';
    document.querySelector('main').style.display = '';
    document.querySelector('footer').style.display = '';
    const url = new URL(window.location); url.searchParams.delete('id'); history.pushState(null,'',url.toString());
}

function fullscreenZone() { const f = document.getElementById('zoneFrame'); if (f.requestFullscreen) f.requestFullscreen(); }

function openModal(t, c) {
    document.getElementById('modalTitle').textContent = t;
    document.getElementById('modalContent').innerHTML = c;
    const o = document.getElementById('modalOverlay');
    o.style.display = 'flex';
    setTimeout(() => o.classList.add('open'), 10);
}

function closeModal() {
    const o = document.getElementById('modalOverlay');
    o.classList.remove('open');
    setTimeout(() => o.style.display='none', 250);
}

function openSettings() {
    const isClassic = localStorage.getItem('theme') === 'classic';
    const stats = JSON.parse(localStorage.getItem('userStats')||'{"opens":{},"totalTime":0}');
    const totalOpens = Object.values(stats.opens).reduce((a,b)=>a+b,0);
    const mostPlayedId = Object.keys(stats.opens).reduce((a,b)=>stats.opens[a]>stats.opens[b]?a:b, Object.keys(stats.opens)[0]);
    const mostPlayed = state.games.find(g => g.id==mostPlayedId);
    const hrs = Math.floor(stats.totalTime/3600000);
    const mins = Math.floor((stats.totalTime%3600000)/60000);
    const cloakSite = localStorage.getItem('cloakSite') || 'Google Classroom';
    const cloakMethod = localStorage.getItem('cloakMethod') || 'about:blank';
    const autoCloak = localStorage.getItem('autoCloak') || 'none';
    openModal("Settings", `
        <div class="setting-row">
            <span class="setting-label">Classic Mode</span>
            <div class="toggle ${isClassic?'on':''}" onclick="toggleTheme(!this.classList.contains('on'),this)"></div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Performance Mode</span>
            <div class="toggle ${localStorage.getItem('performanceMode')==='true'?'on':''}" onclick="togglePerf(this)"></div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Close Prevention Popup</span>
            <div class="toggle ${localStorage.getItem('closePreventionEnabled')!=='false'?'on':''}" onclick="toggleClosePrevention(this)"></div>
        </div>
        <div class="setting-row">
            <span class="setting-label">Game Card Size</span>
            <select class="set-select" onchange="setGameSize(this.value)">
                <option value="tiny" ${localStorage.getItem('gameSize')==='tiny'?'selected':''}>Tiny</option>
                <option value="small" ${localStorage.getItem('gameSize')==='small'?'selected':''}>Small</option>
                <option value="medium" ${localStorage.getItem('gameSize')==='medium'?'selected':''}>Medium</option>
                <option value="default" ${!localStorage.getItem('gameSize')||localStorage.getItem('gameSize')==='default'?'selected':''}>Default</option>
                <option value="large" ${localStorage.getItem('gameSize')==='large'?'selected':''}>Large</option>
                <option value="xlarge" ${localStorage.getItem('gameSize')==='xlarge'?'selected':''}>XL</option>
            </select>
        </div>

        <div class="sec-divider">
            <h4>Theme Customizer</h4>
            <div class="setting-row">
                <span class="setting-label">Preset Themes</span>
                <select class="set-select" id="themePreset" onchange="applyThemePreset(this.value)">
                    <option value="default">Default (Green)</option>
                    <option value="pink">Hot Pink</option>
                    <option value="blue">Ocean Blue</option>
                    <option value="purple">Purple Dream</option>
                    <option value="orange">Sunset Orange</option>
                    <option value="red">Crimson Red</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">Accent Color</span>
                <input type="color" id="accentColorPicker" value="${localStorage.getItem('accentColor')||'#00f5a0'}" onchange="applyAccent(this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">Background Color</span>
                <input type="color" id="bgColorPicker" value="${localStorage.getItem('bgColor')||'#050508'}" onchange="applyBgColor(this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">Card Color</span>
                <input type="color" id="cardColorPicker" value="${localStorage.getItem('cardColor')||'#141420'}" onchange="applyCardColor(this.value)">
            </div>
            <div class="setting-row">
                <button class="set-btn" onclick="resetColors()">Reset All Colors</button>
            </div>
            <div style="margin-top:1rem;">
                <span class="setting-label" style="display:block;margin-bottom:0.5rem;font-size:0.8rem;">Custom CSS</span>
                <textarea id="customCSSInput" placeholder="Enter custom CSS..." style="width:100%;height:90px;padding:0.5rem;border:1px solid var(--border);border-radius:var(--r);background:var(--c3);color:var(--text);font-family:var(--font-mono);font-size:11px;resize:vertical">${localStorage.getItem('customCSS')||''}</textarea>
                <button class="set-btn" style="margin-top:0.4rem;width:100%;" onclick="applyCustomCSS()">Apply CSS</button>
            </div>
        </div>

        <div class="sec-divider">
            <h4>Tab Cloak</h4>
            <div class="setting-row">
                <span class="setting-label">Quick Cloak</span>
                <button class="set-btn" onclick="tabCloak()">Configure</button>
            </div>
            <div class="setting-row">
                <span class="setting-label">Cloak Site</span>
                <select class="set-select" id="cloakSiteSelect" onchange="localStorage.setItem('cloakSite',this.value);toggleCustomCloakRows(this.value)">
                    <option ${cloakSite==='Google Classroom'?'selected':''}>Google Classroom</option>
                    <option ${cloakSite==='Clever'?'selected':''}>Clever</option>
                    <option ${cloakSite==='Edpuzzle'?'selected':''}>Edpuzzle</option>
                    <option ${cloakSite==='IXL'?'selected':''}>IXL</option>
                    <option ${cloakSite==='Gmail'?'selected':''}>Gmail</option>
                    <option ${cloakSite==='Google Docs'?'selected':''}>Google Docs</option>
                    <option ${cloakSite==='Google Slides'?'selected':''}>Google Slides</option>
                    <option ${cloakSite==='Khan Academy'?'selected':''}>Khan Academy</option>
                    <option ${cloakSite==='Custom'?'selected':''}>Custom</option>
                </select>
            </div>
            <div id="customCloakTitleRow" class="setting-row" style="display:${cloakSite==='Custom'?'flex':'none'}">
                <span class="setting-label">Custom Title</span>
                <input type="text" id="customCloakTitle" placeholder="Page title" value="${localStorage.getItem('customCloakTitle')||''}" onchange="localStorage.setItem('customCloakTitle',this.value)" style="padding:0.4rem 0.6rem;border:1px solid var(--border);border-radius:var(--r);background:var(--c3);color:var(--text);font-size:0.8rem;width:160px;">
            </div>
            <div id="customCloakFaviconRow" class="setting-row" style="display:${cloakSite==='Custom'?'flex':'none'}">
                <span class="setting-label">Custom Favicon URL</span>
                <input type="text" id="customCloakFavicon" placeholder="https://..." value="${localStorage.getItem('customCloakFavicon')||''}" onchange="localStorage.setItem('customCloakFavicon',this.value)" style="padding:0.4rem 0.6rem;border:1px solid var(--border);border-radius:var(--r);background:var(--c3);color:var(--text);font-size:0.8rem;width:160px;">
            </div>
            <div class="setting-row">
                <span class="setting-label">Cloak Method</span>
                <div style="display:flex;gap:1rem;">
                    <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.8rem;color:var(--muted);">
                        <input type="radio" name="cloakMethod" value="about:blank" ${cloakMethod==='about:blank'?'checked':''} onchange="localStorage.setItem('cloakMethod',this.value)"> about:blank
                    </label>
                    <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.8rem;color:var(--muted);">
                        <input type="radio" name="cloakMethod" value="blob:null" ${cloakMethod==='blob:null'?'checked':''} onchange="localStorage.setItem('cloakMethod',this.value)"> blob:null
                    </label>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Open in Cloak</span>
                <button class="set-btn" onclick="openInCloak()">Open Now</button>
            </div>
            <div class="setting-row">
                <span class="setting-label">Auto Cloak on Load</span>
                <select class="set-select" onchange="localStorage.setItem('autoCloak',this.value)">
                    <option value="none" ${autoCloak==='none'?'selected':''}>Disabled</option>
                    <option value="about:blank" ${autoCloak==='about:blank'?'selected':''}>about:blank</option>
                    <option value="blob:null" ${autoCloak==='blob:null'?'selected':''}>blob:null</option>
                </select>
            </div>
        </div>

        <div class="sec-divider">
            <h4>Your Stats</h4>
            <div style="color:var(--muted);line-height:2.4;font-family:var(--font-mono);font-size:0.75rem;">
                <div>GAMES OPENED: <span style="color:var(--accent)">${totalOpens}</span></div>
                <div>MOST PLAYED: <span style="color:var(--accent)">${mostPlayed?mostPlayed.name:'—'}</span></div>
                <div>TIME ON SITE: <span style="color:var(--accent)">${hrs}h ${mins}m</span></div>
            </div>
        </div>

        <div class="sec-divider">
            <h4>Save Data</h4>
            <div class="setting-row">
                <span class="setting-label">Export Save</span>
                <button class="set-btn" onclick="saveData()">Export</button>
            </div>
            <div class="setting-row">
                <span class="setting-label">Import Save</span>
                <button class="set-btn" onclick="document.getElementById('importFile').click()">Import</button>
            </div>
        </div>
    `);
}

function applyAccent(color) {
    localStorage.setItem('accentColor', color);
    document.documentElement.style.setProperty('--accent', color);
}
function applyBgColor(color) {
    localStorage.setItem('bgColor', color);
    document.documentElement.style.setProperty('--c0', color);
}
function applyCardColor(color) {
    localStorage.setItem('cardColor', color);
    document.documentElement.style.setProperty('--c2', color);
}
function resetColors() {
    ['accentColor','bgColor','cardColor'].forEach(k => localStorage.removeItem(k));
    document.documentElement.style.setProperty('--accent','#00f5a0');
    document.documentElement.style.setProperty('--c0','#050508');
    document.documentElement.style.setProperty('--c2','#141420');
    const ap = document.getElementById('accentColorPicker'); if(ap) ap.value='#00f5a0';
    const bp = document.getElementById('bgColorPicker'); if(bp) bp.value='#050508';
    const cp = document.getElementById('cardColorPicker'); if(cp) cp.value='#141420';
}
const THEME_PRESETS = {
    default: { accent:'#00f5a0', bg:'#050508', card:'#141420' },
    pink:    { accent:'#fc2651', bg:'#080510', card:'#180d1c' },
    blue:    { accent:'#00d4ff', bg:'#020d14', card:'#071828' },
    purple:  { accent:'#a855f7', bg:'#06020e', card:'#120820' },
    orange:  { accent:'#ff6b35', bg:'#0a0502', card:'#1a0e06' },
    red:     { accent:'#ff3355', bg:'#080204', card:'#18060a' },
};
function applyThemePreset(key) {
    const p = THEME_PRESETS[key]; if (!p) return;
    applyAccent(p.accent); applyBgColor(p.bg); applyCardColor(p.card);
    const ap = document.getElementById('accentColorPicker'); if(ap) ap.value=p.accent;
    const bp = document.getElementById('bgColorPicker'); if(bp) bp.value=p.bg;
    const cp = document.getElementById('cardColorPicker'); if(cp) cp.value=p.card;
}
function applyCustomCSS() {
    const css = document.getElementById('customCSSInput')?.value || '';
    localStorage.setItem('customCSS', css);
    let el = document.getElementById('customCSSStyle');
    if (!el) { el=document.createElement('style');el.id='customCSSStyle';document.head.appendChild(el); }
    el.textContent = css;
}
function toggleCustomCloakRows(val) {
    const show = val === 'Custom';
    document.getElementById('customCloakTitleRow').style.display = show?'flex':'none';
    document.getElementById('customCloakFaviconRow').style.display = show?'flex':'none';
}
function getCloakTitle() {
    const site = localStorage.getItem('cloakSite') || 'Google Classroom';
    if (site === 'Custom') return localStorage.getItem('customCloakTitle') || 'My Drive - Google Drive';
    return {
        'Google Classroom':'Classes','Clever':'Clever | Portal','Edpuzzle':'Edpuzzle',
        'IXL':'IXL | Dashboard','Gmail':'Gmail','Google Docs':'Google Docs',
        'Google Slides':'Google Slides','Khan Academy':'Khan Academy'
    }[site] || 'Google Classroom';
}
function getCloakFavicon() {
    const site = localStorage.getItem('cloakSite') || 'Google Classroom';
    if (site === 'Custom') return localStorage.getItem('customCloakFavicon') || 'https://www.google.com/favicon.ico';
    return {
        'Google Classroom':'https://ssl.gstatic.com/classroom/favicon.png',
        'Clever':'https://clever.com/favicon.ico',
        'Edpuzzle':'https://edpuzzle.com/favicon.ico',
        'IXL':'https://www.ixl.com/favicon.ico',
        'Gmail':'https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico',
        'Google Docs':'https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico',
        'Google Slides':'https://ssl.gstatic.com/docs/presentations/images/favicon5.ico',
        'Khan Academy':'https://cdn.kastatic.org/images/favicon.ico'
    }[site] || 'https://ssl.gstatic.com/classroom/favicon.png';
}
function openInCloak() {
    const method = localStorage.getItem('cloakMethod') || 'about:blank';
    closeModal();
    if (method === 'about:blank') openInAboutBlank();
    else openInBlobNull();
}
async function openInAboutBlank() {
    const win = window.open('about:blank','_blank');
    if (!win) { alert('Popup blocked! Please allow popups.'); return; }
    const title = getCloakTitle(), favicon = getCloakFavicon(), src = window.location.href;
    win.document.open();
    win.document.write(`<!DOCTYPE html><html><head><title>${title}</title><link rel="icon" href="${favicon}"><style>*{margin:0;padding:0}html,body{width:100%;height:100%;overflow:hidden}iframe{width:100%;height:100%;border:none;display:block}</style></head><body><iframe src="${src}"></iframe></body></html>`);
    win.document.close();
}
function openInBlobNull() {
    const title = getCloakTitle(), favicon = getCloakFavicon();
    let html = document.documentElement.outerHTML;
    html = html.replace('<html','<html data-cloaked="true"');
    html = html.replace(/<title>[^<]*<\/title>/,'<title>'+title+'</title>');
    html = html.replace(/<link[^>]*rel=["']icon["'][^>]*>/gi,'');
    html = html.replace('</head>',`<link rel="icon" href="${favicon}"></head>`);
    const blob = new Blob([html],{type:'text/html'});
    window.open(URL.createObjectURL(blob),'_blank');
}
function toggleClosePrevention(btn) {
    const wasOn = btn.classList.contains('on');
    btn.classList.toggle('on');
    if (wasOn) { localStorage.setItem('closePreventionEnabled','false'); window.removeEventListener('beforeunload',beforeUnloadHandler); }
    else { localStorage.removeItem('closePreventionEnabled'); window.addEventListener('beforeunload',beforeUnloadHandler); }
}
function beforeUnloadHandler(e) { e.preventDefault(); e.returnValue=''; return ''; }

function toggleTheme(enable, btn) {
    state.theme = enable ? 'classic' : 'modern';
    localStorage.setItem('theme', state.theme);
    if (btn) btn.classList.toggle('on');
    if (enable) {
        document.body.classList.add('classic-theme');
        document.getElementById('modernView').classList.add('hidden');
        document.getElementById('classicView').classList.remove('hidden');
    } else {
        document.body.classList.remove('classic-theme');
        document.getElementById('modernView').classList.remove('hidden');
        document.getElementById('classicView').classList.add('hidden');
        initSwipers();
    }
}

function togglePerf(btn) {
    const on = !btn.classList.contains('on');
    localStorage.setItem('performanceMode', on);
    btn.classList.toggle('on');
    document.body.classList.toggle('perf-mode', on);
}

function tabCloak() {
    const t = prompt("Page title:", "Google Classroom");
    const i = prompt("Favicon URL:", "https://ssl.gstatic.com/classroom/favicon.png");
    if (t) document.title = t;
    if (i) { let l = document.querySelector("link[rel~='icon']"); if (!l) { l=document.createElement('link');l.rel='icon';document.head.appendChild(l);} l.href=i; }
}

function setGameSize(size) {
    localStorage.setItem('gameSize', size);
    const map = {tiny:'80px',small:'120px',medium:'155px',default:'190px',large:'240px',xlarge:'290px'};
    let s = document.getElementById('gameSizeStyle');
    if (!s) { s=document.createElement('style');s.id='gameSizeStyle';document.head.appendChild(s); }
    s.textContent = `.grid{grid-template-columns:repeat(auto-fill,minmax(${map[size]},1fr))}`;
}

function toggleSection(id, titleEl) {
    const el = document.getElementById(id);
    const arrow = titleEl.querySelector('.collapse-arrow');
    if (el.style.display === 'none') { el.style.display='grid'; arrow.style.transform='rotate(0deg)'; }
    else { el.style.display='none'; arrow.style.transform='rotate(-90deg)'; }
}

function openDMCA() {
    openModal("DMCA Policy", `
        <p style="margin-bottom:1rem;">If you own a game hosted here and would like it removed, please send a removal request. We respond promptly to all legitimate takedown requests.</p>
        <p>Include: game name, proof of ownership, and your contact information. We will remove the game within 48 hours of verifying your claim.</p>
    `);
}

function openPrivacy() {
    openModal("Privacy Policy", `
        <p style="margin-bottom:1rem;"><strong style="color:var(--text)">Last updated April 2025</strong></p>
        <p style="margin-bottom:1rem;">This site does not collect personal information. We do not use tracking cookies for advertising. All save data (favorites, settings, play history) is stored locally in your browser and never transmitted to our servers.</p>
        <p style="margin-bottom:1rem;">We use CDN services (jsDelivr) to serve game files. These services may collect standard access logs including IP addresses and timestamps as part of normal CDN operation.</p>
        <p>We do not sell, share, or otherwise distribute any user data to third parties.</p>
    `);
}

// Stats (cached)
let _allStatsCache = null, _statsFetchPromise = null;
function loadCachedStats() {
    try {
        const c = localStorage.getItem('statsCache_v2');
        if (!c) return null;
        const d = JSON.parse(c);
        if (!d.timestamp || !d.stats || (Date.now()-d.timestamp)>3600000 || Object.keys(d.stats).length<100) { localStorage.removeItem('statsCache_v2'); return null; }
        return d.stats;
    } catch(e) { localStorage.removeItem('statsCache_v2'); return null; }
}
function saveCachedStats(s) { try { localStorage.setItem('statsCache_v2', JSON.stringify({timestamp:Date.now(),stats:s})); } catch(e){} }

async function getAllStats(force=false) {
    if (!force && _allStatsCache) return _allStatsCache;
    if (!force) { const c = loadCachedStats(); if (c) { _allStatsCache=c; return c; } }
    if (_statsFetchPromise) return _statsFetchPromise;
    _statsFetchPromise = (async () => {
        const BASE = 'https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files';
        const map = Object.create(null);
        let page=1, empty=0;
        while (empty<2) {
            const pages = Array.from({length:10},(_,i)=>page+i);
            const results = await Promise.all(pages.map(p => fetch(`${BASE}?period=year&page=${p}&limit=100`).then(r=>r.ok?r.json():[]).catch(()=>[])));
            let found = false;
            for (const data of results) {
                if (!Array.isArray(data)||!data.length) continue;
                found = true;
                for (const item of data) {
                    if (!item?.name) continue;
                    const m = item.name.match(/^\/(\d+)([.-])/);
                    if (!m) continue;
                    if (!map[m[1]]) map[m[1]]={hits:0,bandwidth:0};
                    map[m[1]].hits += item.hits?.total??0;
                    map[m[1]].bandwidth += item.bandwidth?.total??0;
                }
            }
            empty = found ? 0 : empty+1;
            page += 10;
        }
        _allStatsCache = map; saveCachedStats(map); _statsFetchPromise=null;
        updatePlayCounts(); return map;
    })();
    return _statsFetchPromise;
}

async function getStats(id) { const s = await getAllStats(); return s[String(id)]?.hits??0; }

async function showZoneInfo() {
    const id = Number(document.getElementById('zoneId').textContent);
    openModal("Game Info", "<p>Loading...</p>");
    try {
        const [commits, stats] = await Promise.all([
            fetch(`https://api.github.com/repos/gn-math/html/commits?path=${id}.html`).then(r=>r.json()),
            getStats(id)
        ]);
        const g = state.games.find(x=>x.id===id);
        document.getElementById('modalTitle').textContent = g?.name||'Game Info';
        const date = new Date(commits.at(-1).commit.author.date);
        const formatted = new Intl.DateTimeFormat("en-US",{month:"long",day:"numeric",year:"numeric"}).format(date);
        document.getElementById('modalContent').innerHTML = `
            <div style="font-family:var(--font-mono);font-size:0.78rem;line-height:2.5;">
                <div>ID: <span style="color:var(--accent)">${id}</span></div>
                <div>NAME: <span style="color:var(--accent)">${g?.name||'—'}</span></div>
                ${g?.author?`<div>AUTHOR: <span style="color:var(--accent)">${g.author}</span></div>`:''}
                ${g?.authorLink?`<div>LINK: <a style="color:var(--accent2)" href="${g.authorLink}" target="_blank">${g.authorLink}</a></div>`:''}
                ${g?.special?`<div>TAGS: <span style="color:var(--accent)">${g.special.join(', ')}</span></div>`:''}
                <div>ADDED: <span style="color:var(--accent)">${formatted}</span></div>
                <div>TOTAL PLAYS: <span style="color:var(--accent)">${Number(stats).toLocaleString()}</span></div>
            </div>
        `;
    } catch(e) { document.getElementById('modalContent').innerHTML = '<p>Could not load info.</p>'; }
}

function sanitizeData(obj, ml=1000, ma=10000) {
    if (typeof obj==='string') return obj.length>ml?obj.slice(0,ml)+'...':obj;
    if (obj instanceof Uint8Array) return obj.length>ma?`[Uint8Array too large]`:obj;
    if (Array.isArray(obj)) return obj.map(x=>sanitizeData(x,ml,ma));
    if (obj&&typeof obj==='object') { const n={}; for (const k in obj) if (obj.hasOwnProperty(k)) n[k]=sanitizeData(obj[k],ml,ma); return n; }
    return obj;
}

async function saveData() {
    alert("Gathering data — please wait and don't close this tab.");
    const result = { cookies:document.cookie, localStorage:{...localStorage}, sessionStorage:{...sessionStorage}, indexedDB:{} };
    const dbs = await indexedDB.databases();
    for (const dbInfo of dbs) {
        if (!dbInfo.name) continue;
        result.indexedDB[dbInfo.name]={};
        await new Promise((res,rej) => {
            const req = indexedDB.open(dbInfo.name,dbInfo.version);
            req.onerror = ()=>rej(req.error);
            req.onsuccess = ()=>{
                const db=req.result, stores=Array.from(db.objectStoreNames);
                if (!stores.length){res();return;}
                const tx=db.transaction(stores,"readonly");
                Promise.all(stores.map(s=>new Promise((rs,rj)=>{
                    result.indexedDB[dbInfo.name][s]=[];
                    const gr=tx.objectStore(s).getAll();
                    gr.onsuccess=()=>{result.indexedDB[dbInfo.name][s]=sanitizeData(gr.result,1000,100);rs();};
                    gr.onerror=()=>rj(gr.error);
                }))).then(res);
            };
        });
    }
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify(result)],{type:"application/octet-stream"}));
    a.download=`arcade-zone-save-${Date.now()}.data`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

async function loadData(event) {
    const file=event.target.files[0]; if(!file) return;
    alert("Loading data — please wait.");
    const reader=new FileReader();
    reader.onload = async e => {
        const data=JSON.parse(e.target.result);
        if (data.cookies) data.cookies.split(';').forEach(c=>document.cookie=c.trim());
        if (data.localStorage) for (const k in data.localStorage) localStorage.setItem(k,data.localStorage[k]);
        if (data.sessionStorage) for (const k in data.sessionStorage) sessionStorage.setItem(k,data.sessionStorage[k]);
        alert("Data loaded successfully.");
    };
    reader.readAsText(file);
}

// Init
const savedAccent = localStorage.getItem('accentColor');
if (savedAccent) document.documentElement.style.setProperty('--accent', savedAccent);
const savedBg = localStorage.getItem('bgColor');
if (savedBg) document.documentElement.style.setProperty('--c0', savedBg);
const savedCard = localStorage.getItem('cardColor');
if (savedCard) document.documentElement.style.setProperty('--c2', savedCard);
const savedSize = localStorage.getItem('gameSize'); if (savedSize) setGameSize(savedSize);
if (localStorage.getItem('performanceMode')==='true') document.body.classList.add('perf-mode');
if (localStorage.getItem('closePreventionEnabled') !== 'false') window.addEventListener('beforeunload', beforeUnloadHandler);
const savedCSS = localStorage.getItem('customCSS');
if (savedCSS) { const s=document.createElement('style');s.id='customCSSStyle';s.textContent=savedCSS;document.head.appendChild(s); }

// Auto cloak
(function checkAutoCloak() {
    if (document.documentElement.dataset.cloaked === 'true') return;
    const auto = localStorage.getItem('autoCloak') || 'none';
    if (auto === 'about:blank') {
        const win = window.open('about:blank','_blank');
        if (win) {
            const t=getCloakTitle(),f=getCloakFavicon();
            let h=document.documentElement.outerHTML;
            h=h.replace('<html','<html data-cloaked="true"');
            h=h.replace(/<title>[^<]*<\/title>/,'<title>'+t+'</title>');
            h=h.replace(/<link[^>]*rel=["']icon["'][^>]*>/gi,'');
            h=h.replace('</head>',`<link rel="icon" href="${f}"></head>`);
            win.document.write(h); win.document.close();
            window.location.replace('https://www.google.com');
        }
    } else if (auto === 'blob:null') {
        openInBlobNull();
        setTimeout(()=>window.location.replace('https://www.google.com'),300);
    }
})();

function waitForSwiper() {
    if (typeof Swiper !== 'undefined') { init(); }
    else { setTimeout(waitForSwiper, 50); }
}
if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', waitForSwiper);
else waitForSwiper();
</script>
</body>
</html>
